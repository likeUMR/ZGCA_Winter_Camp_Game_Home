<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>游戏列表</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="list-page">
    <!-- 顶部导航 -->
    <div class="header">
        <div class="user-card" onclick="location.href='ranking.html'">
            <div class="rank-title" id="total-rank"><u>排名</u>：--</div>
            <div class="user-details">
                <div class="user-info" id="display-name">姓名：--</div>
                <div class="user-info" id="display-id">报名号&nbsp;&nbsp;&nbsp;：--</div>
            </div>
        </div>
    </div>

    <h2 class="section-title">GAME LIST</h2>

    <!-- 游戏卡片列表 -->
    <div class="game-list">
        <!-- 游戏 1 -->
        <div class="game-card" onclick="playGame('zgca-sliding-puzzle', 'https://gallery.liruochen.cn/zgca-sliding-puzzle/')">
            <img src="images/game_thumb1.jpg" class="game-thumb">
            <div class="game-info">
                <div class="game-titles">
                    <h3>Sliding Puzzle</h3>
                    <p class="cn-name">学院华容道</p>
                </div>
                <div class="game-progress">
                    <p class="progress-text" id="stat-zgca-sliding-puzzle">本关状态：未完成</p>
                </div>
            </div>
            <div class="trophy-circle gray" id="trophy-zgca-sliding-puzzle"><img src="images/icon_trophy.svg"></div>
        </div>

        <!-- 游戏 2 -->
        <div class="game-card" onclick="playGame('craft-big-boss', 'https://gallery.liruochen.cn/craft-big-boss/')">
            <img src="images/game_thumb2.jpg" class="game-thumb">
            <div class="game-info">
                <div class="game-titles">
                    <h3>Craft Big Boss</h3>
                    <p class="cn-name">合成院长</p>
                </div>
                <div class="game-progress">
                    <p class="progress-text" id="stat-craft-big-boss">本关状态：未完成</p>
                </div>
            </div>
            <div class="trophy-circle gray" id="trophy-craft-big-boss"><img src="images/icon_trophy.svg"></div>
        </div>

        <!-- 游戏 3 -->
        <div class="game-card" onclick="playGame('college-link-connect', 'https://gallery.liruochen.cn/college-link-connect/')">
            <img src="images/game_thumb3.jpg" class="game-thumb">
            <div class="game-info">
                <div class="game-titles">
                    <h3>College Link Connect</h3>
                    <p class="cn-name">共建高校连连看</p>
                </div>
                <div class="game-progress">
                    <p class="progress-text" id="stat-college-link-connect">本关状态：未完成</p>
                </div>
            </div>
            <div class="trophy-circle gray" id="trophy-college-link-connect"><img src="images/icon_trophy.svg"></div>
        </div>
    </div>

    <!-- 全屏游戏预览层 -->
    <div id="game-overlay" class="game-overlay">
    </div>

    <script>
        const API_BASE = 'https://leaderboard.liruochen.cn/api';
        const userName = localStorage.getItem('game_user_name');
        const userId = localStorage.getItem('game_user_id');
        const GAMES = ['zgca-sliding-puzzle', 'craft-big-boss', 'college-link-connect'];
        let gameResults = {};

        // 自动识别环境：本地测试使用 8080 端口，生产环境使用相对路径
        const isLocalTest = window.location.hostname === '10.100.69.19';
        const LOCAL_GAME_URLS = isLocalTest ? {
            'zgca-sliding-puzzle': 'http://10.100.69.19:8080/'
        } : {};

        if (userName && userId) {
            document.getElementById('display-name').innerText = `姓名：${userName}`;
            document.getElementById('display-id').innerHTML = `报名号&nbsp;&nbsp;&nbsp;：${userId}`;
        } else {
            location.href = 'index.html';
        }

        // 核心逻辑：获取排名并根据 score 点亮进度条
        async function fetchGameStats(gameId) {
            try {
                const response = await fetch(`${API_BASE}/player_score`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        game_id: gameId,
                        user_id: userId,
                        field_id: 'clear_time'
                    })
                });

                if (!response.ok) throw new Error('Backend Offline');
                const data = await response.json();
                gameResults[gameId] = data;
                updateGameUI(gameId, data);

            } catch (e) {
                console.error(`获取 ${gameId} 状态失败:`, e);
                gameResults[gameId] = {}; // 标记该游戏已查询但无结果，防止阻塞总分检查
            }
            checkTotalRank();
        }

        // 统一的 UI 更新函数
        function updateGameUI(gameId, data) {
            if (data && data.score !== undefined) {
                const score = parseInt(data.score);
                
                // 1. 更新状态显示
                const statEl = document.getElementById(`stat-${gameId}`);
                // 根据排行榜说明：score 为 1 代表已通关（TIME_SENSITIVE_FIELDS 机制）
                if (score === 1) {
                    statEl.innerText = `本关状态：已完成`;
                    statEl.style.color = '#ffb800';
                } else {
                    statEl.innerText = `本关状态：未完成`;
                    statEl.style.color = 'white';
                }

                // 2. 只有 score 为 1 才点亮奖杯
                const trophy = document.getElementById(`trophy-${gameId}`);
                if (score === 1) {
                    trophy.classList.remove('gray');
                    trophy.classList.add('gold');
                } else {
                    trophy.classList.add('gray');
                    trophy.classList.remove('gold');
                }
            }
        }

        let isCheckingTotal = false;
        async function checkTotalRank() {
            // 检查是否所有游戏都已获取到结果
            if (Object.keys(gameResults).length < GAMES.length) return;
            
            // 防止重复触发
            if (isCheckingTotal) return;
            isCheckingTotal = true;

            const allCleared = GAMES.every(id => gameResults[id] && parseInt(gameResults[id].score) === 1);
            const totalRankEl = document.getElementById('total-rank');

            if (allCleared) {
                try {
                    // 如果全部通关，尝试上传总成绩到 zgca-total
                    // 系统会自动记录第一次上传的时间作为排名依据
                    // 统一使用报名号 (userId) 作为唯一标识
                    const uploadRes = await fetch(`${API_BASE}/upload`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            game_id: 'zgca-total',
                            user_id: userId,
                            score: 1,
                            field_id: 'clear_time'
                        })
                    });

                    // 获取总排名
                    const response = await fetch(`${API_BASE}/player_score`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            game_id: 'zgca-total',
                            user_id: userId,
                            field_id: 'clear_time'
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        totalRankEl.innerHTML = `<u>排名</u>：${data.rank || '--'}`;
                    } else {
                        throw new Error('Rank Fetch Failed');
                    }
                } catch (e) {
                    console.error('获取总排名失败:', e);
                    totalRankEl.innerHTML = `<u>排名</u>：--`;
                }
            } else {
                totalRankEl.innerHTML = `<u>排名</u>：--`;
            }
            isCheckingTotal = false;
        }

        GAMES.forEach(fetchGameStats);

        let isGameOpen = false;

        // 修改后的游戏打开逻辑：动态创建 Iframe，彻底解决微信历史记录问题
        function playGame(gameId, customUrl) {
            // 核心逻辑优化：
            // 1. 如果是本地环境且配置了映射，强制走本地端口 (LOCAL_GAME_URLS)
            // 2. 否则走手动传入的正式链接 (customUrl)
            // 3. 最后才尝试默认路径
            let baseUrl = (isLocalTest && LOCAL_GAME_URLS[gameId]) 
                ? LOCAL_GAME_URLS[gameId] 
                : (customUrl || `${gameId}/index.html`);
            
            // 如果 baseUrl 不以 http 开头且不是以 / 结尾，补充 index.html
            if (!baseUrl.startsWith('http') && !baseUrl.endsWith('.html')) {
                baseUrl = baseUrl.endsWith('/') ? baseUrl + 'index.html' : baseUrl + '/index.html';
            }
            
            const targetUrl = `${baseUrl}${baseUrl.includes('?') ? '&' : '?'}userid=${encodeURIComponent(userId)}&username=${encodeURIComponent(userName)}`;
            
            const overlay = document.getElementById('game-overlay');
            
            // 1. 清理旧的 iframe
            const oldFrame = document.getElementById('game-frame');
            if (oldFrame) oldFrame.remove();

            // 2. 动态创建
            const frame = document.createElement('iframe');
            frame.id = 'game-frame';
            frame.className = 'game-iframe';
            frame.src = targetUrl;
            overlay.appendChild(frame);

            // 3. 显示 UI
            overlay.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            if (!isGameOpen) {
                isGameOpen = true;
                history.pushState({ inGame: true }, "");
            }
        }

        // 真正的 UI 关闭和清理逻辑
        function closeGameUI() {
            const overlay = document.getElementById('game-overlay');
            const frame = document.getElementById('game-frame');

            overlay.style.display = 'none';
            document.body.style.overflow = 'auto';
            
            if (frame) frame.remove(); // 销毁 iframe
            
            isGameOpen = false;
            ['zgca-sliding-puzzle', 'craft-big-boss', 'college-link-connect'].forEach(fetchGameStats);
        }

        // 监听系统返回键（微信/浏览器）
        window.addEventListener('popstate', function(event) {
            if (isGameOpen) {
                closeGameUI();
            }
        });
    </script>
</body>
</html>